<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Practice - Trading Simulator</title>
    <script src="charts.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a;
            color: #fff;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .header h1 {
            color: #00d4ff;
            font-size: 1.5em;
        }
        .stats {
            display: flex;
            gap: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.8em;
            color: #888;
        }
        .stat.correct .stat-value { color: #00ff88; }
        .stat.wrong .stat-value { color: #ff6b6b; }
        .stat.streak .stat-value { color: #f7b731; }
        
        .main {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .chart-section {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .ticker-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .ticker-symbol {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d4ff;
        }
        .ticker-change {
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
        }
        .ticker-change.positive {
            background: #00ff8820;
            color: #00ff88;
        }
        .timeframe-tabs {
            display: flex;
            gap: 5px;
        }
        .tf-tab {
            padding: 8px 16px;
            background: #0d1117;
            border: 1px solid #333;
            border-radius: 5px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tf-tab.active {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }
        .tf-tab:hover:not(.active) {
            border-color: #00d4ff;
            color: #00d4ff;
        }
        
        #chart-container {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .setup-card {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #333;
        }
        .setup-card h3 {
            color: #00d4ff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .setup-type {
            background: #00d4ff20;
            color: #00d4ff;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.7em;
        }
        .setup-rules {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .setup-rules li {
            margin-left: 20px;
            margin-bottom: 5px;
        }
        
        .question-box {
            background: #0d1117;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .question {
            font-size: 1.1em;
            color: #fff;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-entry {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }
        .btn-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px #00ff8840;
        }
        .btn-skip {
            background: #ff6b6b;
            color: #fff;
        }
        .btn-skip:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px #ff6b6b40;
        }
        .btn-next {
            background: #00d4ff;
            color: #000;
        }
        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px #00d4ff40;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .feedback {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        .feedback.correct {
            background: #00ff8820;
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        .feedback.wrong {
            background: #ff6b6b20;
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
        }
        .feedback h4 {
            margin-bottom: 5px;
        }
        
        .indicators {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .indicator {
            padding: 5px 10px;
            background: #0d1117;
            border-radius: 5px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .indicator.green { color: #00ff88; }
        .indicator.red { color: #ff6b6b; }
        .indicator.yellow { color: #f7b731; }
        
        .level-line {
            position: absolute;
            width: 100%;
            height: 2px;
            pointer-events: none;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            border: 1px solid #333;
        }
        .modal h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        .modal p {
            color: #aaa;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .modal .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .main {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Setup Practice Simulator</h1>
        <div class="stats">
            <div class="stat correct">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat wrong">
                <div class="stat-value" id="wrong-count">0</div>
                <div class="stat-label">Wrong</div>
            </div>
            <div class="stat streak">
                <div class="stat-value" id="streak-count">0</div>
                <div class="stat-label">Streak üî•</div>
            </div>
        </div>
    </div>
    
    <div class="main">
        <div class="chart-section">
            <div class="chart-header">
                <div class="ticker-info">
                    <span class="ticker-symbol" id="ticker-symbol">LOADING</span>
                    <span class="ticker-change positive" id="ticker-change">+0.00%</span>
                </div>
                <div class="timeframe-tabs">
                    <button class="tf-tab active" data-tf="1">1m</button>
                    <button class="tf-tab" data-tf="3">3m</button>
                    <button class="tf-tab" data-tf="5">5m</button>
                </div>
            </div>
            <div id="chart-container"></div>
            <div class="indicators" id="indicators"></div>
        </div>
        
        <div class="sidebar">
            <div class="setup-card">
                <h3>
                    <span id="setup-name">Loading...</span>
                    <span class="setup-type" id="setup-type">SETUP</span>
                </h3>
                <ul class="setup-rules" id="setup-rules">
                    <li>Loading rules...</li>
                </ul>
            </div>
            
            <div class="setup-card">
                <div class="question-box">
                    <div class="question" id="question">
                        Is this a valid entry?
                    </div>
                </div>
                
                <div class="action-buttons" id="action-buttons">
                    <button class="btn btn-entry" id="btn-entry" onclick="submitAnswer(true)">
                        ‚úÖ VALID ENTRY - Take Trade
                    </button>
                    <button class="btn btn-skip" id="btn-skip" onclick="submitAnswer(false)">
                        ‚ùå NO SETUP - Skip
                    </button>
                </div>
                
                <div class="feedback" id="feedback">
                    <h4 id="feedback-title">Result</h4>
                    <p id="feedback-text">Explanation here</p>
                </div>
                
                <button class="btn btn-next" id="btn-next" onclick="nextScenario()" style="display:none; margin-top: 15px;">
                    Next Scenario ‚Üí
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="results-modal">
        <div class="modal-content">
            <h2>üéâ Practice Complete!</h2>
            <p>You've completed 10 scenarios. Here's how you did:</p>
            <div class="stat-grid">
                <div class="stat correct">
                    <div class="stat-value" id="final-correct">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat wrong">
                    <div class="stat-value" id="final-wrong">0</div>
                    <div class="stat-label">Wrong</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="final-accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>
            <button class="btn btn-next" onclick="restartPractice()">Practice Again</button>
        </div>
    </div>

    <script>
        // ============== CHART SETUP ==============
        let chart;
        let candleSeries;
        let volumeSeries;
        let currentScenario = null;
        let currentTimeframe = 1;
        let stats = { correct: 0, wrong: 0, streak: 0, total: 0 };
        
        function initChart() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 500,
                layout: {
                    background: { color: '#0d1117' },
                    textColor: '#888',
                },
                grid: {
                    vertLines: { color: '#1a1a2e' },
                    horzLines: { color: '#1a1a2e' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#333',
                },
                timeScale: {
                    borderColor: '#333',
                    timeVisible: true,
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff88',
                downColor: '#ff6b6b',
                borderUpColor: '#00ff88',
                borderDownColor: '#ff6b6b',
                wickUpColor: '#00ff88',
                wickDownColor: '#ff6b6b',
            });
            
            volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: { type: 'volume' },
                priceScaleId: '',
                scaleMargins: { top: 0.85, bottom: 0 },
            });
            
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: container.clientWidth });
            });
        }
        
        // ============== SCENARIO GENERATION ==============
        const SETUPS = [
            {
                name: 'Parabolic Washout Long',
                type: 'PARABOLIC',
                rules: [
                    'All green candles on 1-min',
                    '5+ green on 3-min',
                    '3+ green on 5-min',
                    'First pullback to support',
                    'NOT 2nd red or 2nd green with wick'
                ],
                generateValid: () => generateParabolicSetup(true),
                generateInvalid: () => generateParabolicSetup(false)
            },
            {
                name: 'VWAP Reclaim',
                type: 'VWAP',
                rules: [
                    'Stock was below VWAP',
                    'Reclaimed VWAP with volume',
                    'All timeframes green above VWAP',
                    'First pullback to VWAP'
                ],
                generateValid: () => generateVWAPSetup(true),
                generateInvalid: () => generateVWAPSetup(false)
            },
            {
                name: 'Opening Range Breakout',
                type: 'ORB',
                rules: [
                    'Broke above 15-min opening range',
                    'All timeframes confirm breakout',
                    'First pullback to breakout level',
                    'Volume on breakout'
                ],
                generateValid: () => generateORBSetup(true),
                generateInvalid: () => generateORBSetup(false)
            },
            {
                name: 'Red to Green',
                type: 'R2G',
                rules: [
                    'Stock was RED on the day',
                    'Crossed previous close, now GREEN',
                    'All timeframes aligned green',
                    'First pullback to prev close level'
                ],
                generateValid: () => generateR2GSetup(true),
                generateInvalid: () => generateR2GSetup(false)
            },
            {
                name: 'HOD Breakout',
                type: 'HOD',
                rules: [
                    'Broke High of Day',
                    'Clean break with volume',
                    'All timeframes aligned',
                    'First pullback to old HOD'
                ],
                generateValid: () => generateHODSetup(true),
                generateInvalid: () => generateHODSetup(false)
            }
        ];
        
        function generateCandleData(basePrice, numCandles, trend, volatility = 0.02) {
            const candles = [];
            let price = basePrice;
            const startTime = Math.floor(Date.now() / 1000) - (numCandles * 60);
            
            for (let i = 0; i < numCandles; i++) {
                const trendBias = trend[i % trend.length];
                const change = (Math.random() - 0.5 + trendBias * 0.3) * volatility * price;
                
                const open = price;
                const close = price + change;
                const high = Math.max(open, close) + Math.random() * volatility * price * 0.5;
                const low = Math.min(open, close) - Math.random() * volatility * price * 0.5;
                const volume = Math.floor(50000 + Math.random() * 200000);
                
                candles.push({
                    time: startTime + i * 60,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2)),
                    volume: volume
                });
                
                price = close;
            }
            return candles;
        }
        
        function generateParabolicSetup(isValid) {
            const basePrice = 10 + Math.random() * 40;
            let trend;
            let explanation;
            
            if (isValid) {
                // Valid: strong uptrend, pullback to support, first touch
                trend = [0.8, 0.7, 0.6, 0.8, 0.7, 0.9, 0.6, 0.5, 0.3, 0.1, -0.2, 0.4]; // Strong up, small pullback
                explanation = "‚úÖ Valid setup: All timeframes green, first pullback to support, continuation expected.";
            } else {
                const invalidType = Math.floor(Math.random() * 3);
                if (invalidType === 0) {
                    // 2nd red candle at support
                    trend = [0.8, 0.7, 0.6, 0.8, 0.5, -0.3, -0.4, -0.2, 0.3];
                    explanation = "‚ùå Invalid: Second red candle at support level - sellers gaining control.";
                } else if (invalidType === 1) {
                    // Weak momentum, mixed candles
                    trend = [0.3, -0.2, 0.4, -0.1, 0.3, 0.2, -0.2, 0.1];
                    explanation = "‚ùå Invalid: Mixed candles, not a parabolic move. No clear buyer control.";
                } else {
                    // Extended, chasing
                    trend = [0.9, 0.9, 0.9, 0.9, 0.9, 0.8, 0.7, 0.6];
                    explanation = "‚ùå Invalid: Too extended, no pullback yet. Chasing.";
                }
            }
            
            return {
                candles: generateCandleData(basePrice, 30, trend),
                isValid,
                explanation,
                supportLevel: basePrice * (1 + (isValid ? 0.08 : 0.05))
            };
        }
        
        function generateVWAPSetup(isValid) {
            const basePrice = 15 + Math.random() * 35;
            const vwap = basePrice * 1.02;
            let trend;
            let explanation;
            
            if (isValid) {
                trend = [-0.3, -0.4, -0.2, -0.1, 0.5, 0.6, 0.4, 0.3, 0.2, -0.1, 0.3];
                explanation = "‚úÖ Valid: Reclaimed VWAP with strength, first pullback to VWAP level.";
            } else {
                trend = [-0.3, -0.2, 0.2, -0.3, 0.1, -0.2, 0.2, 0.1];
                explanation = "‚ùå Invalid: Weak reclaim, chopping around VWAP. No clear control.";
            }
            
            return {
                candles: generateCandleData(basePrice, 30, trend),
                isValid,
                explanation,
                vwapLevel: vwap
            };
        }
        
        function generateORBSetup(isValid) {
            const basePrice = 20 + Math.random() * 30;
            let trend;
            let explanation;
            
            if (isValid) {
                trend = [0.1, -0.1, 0.1, 0.0, 0.6, 0.7, 0.5, 0.3, 0.1, -0.1, 0.4];
                explanation = "‚úÖ Valid: Clean breakout of opening range, first pullback to breakout level.";
            } else {
                trend = [0.2, -0.2, 0.3, -0.3, 0.2, 0.1, -0.2, 0.1];
                explanation = "‚ùå Invalid: Chop within range, no clean breakout yet.";
            }
            
            return {
                candles: generateCandleData(basePrice, 30, trend),
                isValid,
                explanation,
                orbHigh: basePrice * 1.015,
                orbLow: basePrice * 0.985
            };
        }
        
        function generateR2GSetup(isValid) {
            const basePrice = 25 + Math.random() * 25;
            const prevClose = basePrice * 1.02;
            let trend;
            let explanation;
            
            if (isValid) {
                trend = [-0.5, -0.4, -0.3, 0.4, 0.6, 0.5, 0.4, 0.2, 0.1, -0.1, 0.3];
                explanation = "‚úÖ Valid: Clear R2G move, first pullback to previous close.";
            } else {
                trend = [-0.3, -0.2, 0.2, 0.1, -0.2, 0.1, -0.1];
                explanation = "‚ùå Invalid: Weak bounce, still fighting at previous close.";
            }
            
            return {
                candles: generateCandleData(basePrice, 30, trend),
                isValid,
                explanation,
                prevClose: prevClose
            };
        }
        
        function generateHODSetup(isValid) {
            const basePrice = 18 + Math.random() * 32;
            let trend;
            let explanation;
            
            if (isValid) {
                trend = [0.3, 0.4, 0.3, 0.5, 0.6, 0.4, 0.2, 0.1, -0.1, 0.3];
                explanation = "‚úÖ Valid: Broke HOD with volume, first pullback to old HOD.";
            } else {
                trend = [0.3, 0.4, 0.2, -0.3, 0.2, -0.2, 0.1];
                explanation = "‚ùå Invalid: Failed breakout, rejected at HOD.";
            }
            
            return {
                candles: generateCandleData(basePrice, 30, trend),
                isValid,
                explanation,
                hodLevel: basePrice * 1.05
            };
        }
        
        // ============== GAME LOGIC ==============
        function loadScenario() {
            const setup = SETUPS[Math.floor(Math.random() * SETUPS.length)];
            const isValid = Math.random() > 0.4; // 60% valid setups
            
            const scenario = isValid ? setup.generateValid() : setup.generateInvalid();
            scenario.setup = setup;
            
            currentScenario = scenario;
            
            // Update UI
            document.getElementById('setup-name').textContent = setup.name;
            document.getElementById('setup-type').textContent = setup.type;
            document.getElementById('setup-rules').innerHTML = setup.rules.map(r => `<li>${r}</li>`).join('');
            
            // Random ticker
            const tickers = ['MRAM', 'GITE', 'SMCI', 'NVDA', 'IONQ', 'RGTI', 'TSLA', 'AMD', 'MARA', 'RIOT'];
            document.getElementById('ticker-symbol').textContent = tickers[Math.floor(Math.random() * tickers.length)];
            
            const change = (5 + Math.random() * 15).toFixed(2);
            document.getElementById('ticker-change').textContent = `+${change}%`;
            
            // Update chart
            updateChart(1);
            
            // Reset UI
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-entry').disabled = false;
            document.getElementById('btn-skip').disabled = false;
            
            updateIndicators();
        }
        
        function updateChart(timeframe) {
            currentTimeframe = timeframe;
            
            // Update tabs
            document.querySelectorAll('.tf-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.tf) === timeframe);
            });
            
            if (!currentScenario) return;
            
            let data = currentScenario.candles;
            
            // Aggregate candles for higher timeframes
            if (timeframe > 1) {
                data = aggregateCandles(currentScenario.candles, timeframe);
            }
            
            candleSeries.setData(data);
            volumeSeries.setData(data.map(c => ({
                time: c.time,
                value: c.volume,
                color: c.close >= c.open ? '#00ff8840' : '#ff6b6b40'
            })));
            
            chart.timeScale().fitContent();
        }
        
        function aggregateCandles(candles, period) {
            const result = [];
            for (let i = 0; i < candles.length; i += period) {
                const chunk = candles.slice(i, i + period);
                if (chunk.length === period) {
                    result.push({
                        time: chunk[0].time,
                        open: chunk[0].open,
                        high: Math.max(...chunk.map(c => c.high)),
                        low: Math.min(...chunk.map(c => c.low)),
                        close: chunk[chunk.length - 1].close,
                        volume: chunk.reduce((sum, c) => sum + c.volume, 0)
                    });
                }
            }
            return result;
        }
        
        function updateIndicators() {
            const container = document.getElementById('indicators');
            const candles = currentScenario.candles;
            
            // Count green candles
            let green1m = 0, green3m = 0, green5m = 0;
            
            for (let i = candles.length - 1; i >= 0; i--) {
                if (candles[i].close > candles[i].open) green1m++;
                else break;
            }
            
            const candles3m = aggregateCandles(candles, 3);
            for (let i = candles3m.length - 1; i >= 0; i--) {
                if (candles3m[i].close > candles3m[i].open) green3m++;
                else break;
            }
            
            const candles5m = aggregateCandles(candles, 5);
            for (let i = candles5m.length - 1; i >= 0; i--) {
                if (candles5m[i].close > candles5m[i].open) green5m++;
                else break;
            }
            
            container.innerHTML = `
                <div class="indicator ${green1m >= 5 ? 'green' : 'red'}">1m: ${green1m} green</div>
                <div class="indicator ${green3m >= 5 ? 'green' : 'yellow'}">3m: ${green3m} green</div>
                <div class="indicator ${green5m >= 3 ? 'green' : 'yellow'}">5m: ${green5m} green</div>
            `;
        }
        
        function submitAnswer(userSaidValid) {
            const isCorrect = userSaidValid === currentScenario.isValid;
            
            // Update stats
            if (isCorrect) {
                stats.correct++;
                stats.streak++;
            } else {
                stats.wrong++;
                stats.streak = 0;
            }
            stats.total++;
            
            document.getElementById('correct-count').textContent = stats.correct;
            document.getElementById('wrong-count').textContent = stats.wrong;
            document.getElementById('streak-count').textContent = stats.streak;
            
            // Show feedback
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';
            feedback.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;
            document.getElementById('feedback-title').textContent = isCorrect ? '‚úÖ Correct!' : '‚ùå Wrong';
            document.getElementById('feedback-text').textContent = currentScenario.explanation;
            
            // Disable buttons
            document.getElementById('btn-entry').disabled = true;
            document.getElementById('btn-skip').disabled = true;
            document.getElementById('btn-next').style.display = 'block';
            
            // Check if practice complete
            if (stats.total >= 10) {
                setTimeout(showResults, 1500);
            }
        }
        
        function nextScenario() {
            loadScenario();
        }
        
        function showResults() {
            document.getElementById('final-correct').textContent = stats.correct;
            document.getElementById('final-wrong').textContent = stats.wrong;
            document.getElementById('final-accuracy').textContent = Math.round((stats.correct / stats.total) * 100) + '%';
            document.getElementById('results-modal').classList.add('show');
        }
        
        function restartPractice() {
            stats = { correct: 0, wrong: 0, streak: 0, total: 0 };
            document.getElementById('correct-count').textContent = '0';
            document.getElementById('wrong-count').textContent = '0';
            document.getElementById('streak-count').textContent = '0';
            document.getElementById('results-modal').classList.remove('show');
            loadScenario();
        }
        
        // ============== INIT ==============
        document.querySelectorAll('.tf-tab').forEach(tab => {
            tab.addEventListener('click', () => updateChart(parseInt(tab.dataset.tf)));
        });
        
        initChart();
        loadScenario();
    </script>
</body>
</html>
